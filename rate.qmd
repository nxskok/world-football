---
title: "rate"
format: html
---

## Packages

```{r}
library(tidyverse)
library(cmdstanr)
options(mc.cores = 4)
source("functions.R")
source("rate_functions.R")
source("predictions_functions.R")
```

## do more than one

find the ones that need doing and do them (or some of them)

```{r}
update_rate(leagues) 
```

## predictions for upcoming games based on most recent ratings

```{r}
#| warning: false
leagues %>% mutate(r = row_number()) %>% 
  rowwise() %>% 
  mutate(fname = make_fname(country, league, season, part, prefix = "")) %>% 
  mutate(mtime = file.mtime(str_c("fit/", fname))) %>% 
  mutate(size = file.size(str_c("fit/", fname))) %>% 
  filter(!is.na(mtime)) %>% 
  filter(size > 100) %>% 
  ungroup() %>% 
  slice_sample(n = 999) %>%
  pull(fname) %>% 
  map(\(x) league_preds(x)) %>% bind_rows() %>% arrange(ko) -> predictions
predictions %>% View()
write_rds(predictions, "predictions.rds")
```
