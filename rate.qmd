---
title: "rate"
format: html
---

## Packages

```{r}
library(tidyverse)
library(cmdstanr)
options(mc.cores = 4)
source("functions.R")
source("rate_functions.R")
source("predictions_functions.R")
```

## do more than one

find the ones that need doing and do them (or some of them)

## next rate thing

I don't know about italy b.
Figure out what happens the first time a rating is needed.

```{r}
all_next_rate_date(leagues) -> leagues0
leagues0 %>% select(fname, next_rate, dow) 
leagues0  %>% 
  filter(next_rate < now()) -> leagues1
```

pass the relevant ones from there into here (slice leagues to do just a few / specific ones; DO NOT do them all! Though this might be all right now I fixed the next rate date.)

```{r}
leagues1 %>% update_rate() 
```

## predictions for upcoming games based on most recent ratings

```{r}
#| warning: false
leagues %>% mutate(r = row_number()) %>% 
  rowwise() %>% 
  mutate(fname = make_fname(country, league, season, part, prefix = "")) %>% 
  mutate(mtime = file.mtime(str_c("fit/", fname))) %>% 
  mutate(size = file.size(str_c("fit/", fname))) %>% 
  filter(!is.na(mtime)) %>% 
  filter(size > 100) %>% 
  ungroup() %>% 
  slice_sample(n = 999) %>%
  pull(fname) %>% 
  map(\(x) league_preds(x)) %>% bind_rows() %>% arrange(ko) -> predictions
write_rds(predictions, "predictions.rds")
```

display some of these predictions

```{r}
now <- now()
read_rds("predictions.rds") %>% 
  filter(between(ko, now - hours(3), now + hours(2))) %>% 
  arrange(fname) %>% 
  View()
```
