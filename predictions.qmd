---
title: "predictions"
format: html
---

packages

```{r}
library(tidyverse)
library(rvest)
library(stringdist) # idea from https://www.r-bloggers.com/2017/12/vectorize-fuzzy-matching/
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(tidyr::extract)
source("functions.R")
source("rate_functions.R")
source("stats_functions.R")
  source("predictions_functions.R")
```

Predict the football session (run once)

```{r}
the_url <- "https://www.predictthefootball.com/?lang=en_us"
sess <- session(the_url)
form <- html_form(sess)
# form
filled_form <- html_form_set(form[[1]],
                          "LoginForm[email]" = Sys.getenv("PTF_USER"),
                          "LoginForm[password]" = Sys.getenv("PTF_PASS"),
                          "LoginForm[rememberMe]" = 1
                          )

session_submit(sess, filled_form)
```

file name, choose; lookup table

```{r}
fname <- "swe_allsvenskan_2023.rds"
lu <- read_rds(str_c("lu/", fname))
# league_url <- "https://allsvenskan.predictthefootball.com"
# league_url <- "https://championship.predictthefootball.com" # England championship
# league_url <- "https://superleague.predictthefootball.com" # Greece
league_url <- "https://scottish-premier.predictthefootball.com" # Scotland
# league_url <- "https://laliga.predictthefootball.com" # Spain

```

```{r}
get_form(league_url, sess) %>% 
  filter(is.na(pred_1)) -> ptf_form
ptf_form %>% 
  mutate(scores = str_sub(scores, end = 7)) %>% 
  select(name_1, name_2, preds, results, scores) %>% View()
```

go down this far for first games of season (pick the most popular score)

below gets predictions via max ept

```{r}
ptf_form %>% 
  mutate(t1 = best_match(name_1, lu),
         t2 = best_match(name_2, lu)) %>% 
  left_join(lu, by = c("t1" = "team")) %>% 
  left_join(lu, by = c("t2" = "team")) %>%  # id.x and id.y are the teams to look up
  rowwise() %>% 
  mutate(ppd = list(make_ppd(fname, id.x, id.y))) %>% 
  mutate(opt_pred = max_ept(ppd, results, scores)) %>% 
  select(name_1, name_2, opt_pred)
```

similar ideas:

-   table of predictions for upcoming matches (using the ppd idea), can go on the end of ratings

-   predictions for italy

-   sim-league
